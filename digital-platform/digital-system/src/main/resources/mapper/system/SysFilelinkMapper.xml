<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.meide.system.mapper.SysFilelinkMapper">

    <insert id="insertAllGroup" >
        insert into sys_filelink
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.id},#{item.fileGroup},#{item.uri},#{item.createBy},#{item.createTime})
        </foreach>
    </insert>

    <select id="selectUriByGroup" parameterType="java.lang.String" resultType="com.meide.system.domain.entity.SysFilelink">
        select id, group_id, path, file_type, file_name, sign_count, creater, create_time
        from sys_file
        where group_id = #{_parameter}
    </select>

    <insert id="upload" parameterType="com.meide.system.domain.entity.SysFilelink">
        insert into sys_file(
            id, group_id, path, file_type, file_name, sign_count, creater, create_time
        ) values (
            #{id}, #{groupId}, #{path}, #{fileType}, #{fileName}, #{signCount}, #{creater}, #{createTime}
        )
    </insert>

    <update id="updateGroupByIds" parameterType="java.lang.String">
        update sys_file set
        group_id = #{groupId},
        sign_count = 1
        where id in (
        <foreach collection="list" item="item" index="index" separator=",">
                #{item}
            </foreach>
        )
    </update>

    <update id="updateSignByGroupId" parameterType="java.lang.String">
        update sys_file set
            group_id = null,
            sign_count = 0
        where group_id = #{_parameter}
    </update>

    <!-- 查询创建了最起码2小时，并且待删除的数据路径 -->
    <select id="selectFilePathForDelete" resultType="java.lang.String">
        <![CDATA[


                            select path
                            from sys_file
                            where create_time < DATE_ADD(NOW(),INTERVAL-2 HOUR)  and sign_count <= 0

]]>
    </select>
    <select id="selectById" resultType="com.meide.system.domain.entity.SysFilelink">
        select * from sys_file where id=#{id}
    </select>

    <delete id="deleteFileForNeed">
        <![CDATA[


                            delete from sys_file where create_time < DATE_ADD(NOW(),INTERVAL-2 HOUR)  and sign_count <= 0

]]>
    </delete>

    <update id="updateFilesSignCountByGroupIds" parameterType="java.lang.String">
        update sys_file set
        sign_count = sign_count - 1
        where group_id in (
            <foreach collection="list" item="item" index="index" separator=",">
                #{item}
            </foreach>
        )
    </update>

    <update id="updateFilesSignCount" parameterType="java.util.Map">
        update sys_file set
            sign_count = sign_count - 1
        where group_id in (
            select ${fileName}
            from ${table}
            where id in (
                <foreach collection="list" item="item" index="index" separator=",">
                    #{item}
                </foreach>
            )
        )
    </update>

</mapper>
